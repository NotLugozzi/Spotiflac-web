{% extends "base.html" %}

{% block title %}{{ album.name }} - Spotiflac web{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <!-- Album Header -->
    <div class="bg-gradient-to-b from-dark-card to-dark-bg rounded-xl overflow-hidden">
        <div class="flex flex-col md:flex-row items-center md:items-end gap-6 p-6 md:p-8">
            <!-- Album Cover -->
            <div class="flex-shrink-0 w-56 h-56 md:w-64 md:h-64 bg-dark-surface rounded-lg overflow-hidden shadow-2xl">
                {% if album.image_url %}
                <img src="{{ album.image_url }}" alt="{{ album.name }}" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full album-cover-placeholder flex items-center justify-center">
                    <svg class="w-24 h-24 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/>
                    </svg>
                </div>
                {% endif %}
            </div>
            
            <!-- Album Info -->
            <div class="flex-1 text-center md:text-left">
                <p class="text-sm uppercase tracking-wider text-gray-400 mb-2">{{ album.album_type or 'Album' }}</p>
                <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ album.name }}</h1>
                
                {% if artist %}
                <a href="/artists/{{ artist.id }}" class="text-lg text-gray-300 hover:text-white hover:underline">{{ artist.name }}</a>
                {% endif %}
                
                <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 text-sm text-gray-400 mt-3">
                    {% if album.release_date %}
                    <span>{{ album.release_date }}</span>
                    {% endif %}
                    {% if album.total_tracks %}
                    <span class="text-gray-600">•</span>
                    <span>{{ album.total_tracks }} tracks</span>
                    {% endif %}
                    {% if album.label %}
                    <span class="text-gray-600">•</span>
                    <span>{{ album.label }}</span>
                    {% endif %}
                </div>
                
                <!-- Status -->
                <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-4">
                    {% if album.is_owned %}
                    <span class="px-3 py-1 text-sm bg-spotify-green/20 text-spotify-green rounded-full">
                        ✓ In Library
                    </span>
                    {% endif %}
                    {% if album.is_wanted %}
                    <span class="px-3 py-1 text-sm bg-yellow-500/20 text-yellow-400 rounded-full">
                        ★ Wanted
                    </span>
                    {% endif %}
                    {% if download %}
                    <span class="px-3 py-1 text-sm bg-blue-500/20 text-blue-400 rounded-full">
                        {{ download.status }}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-6">
                    {% if not album.is_owned %}
                    <button 
                        hx-post="/api/downloads"
                        hx-vals='{"url": "{{ album.spotify_url }}"}'
                        hx-swap="none"
                        data-success-message="Added to download queue"
                        class="px-6 py-2.5 bg-spotify-green text-black font-medium rounded-full hover:bg-green-400 transition-colors flex items-center"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Album
                    </button>
                    {% endif %}
                    
                    <button 
                        hx-patch="/api/albums/{{ album.id }}?is_wanted={{ 'false' if album.is_wanted else 'true' }}"
                        hx-swap="none"
                        class="px-6 py-2.5 bg-dark-card border border-gray-700 font-medium rounded-full hover:bg-dark-hover transition-colors flex items-center"
                    >
                        {% if album.is_wanted %}
                        <svg class="w-5 h-5 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        Remove from Wanted
                        {% else %}
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        Add to Wanted
                        {% endif %}
                    </button>
                    
                    {% if album.spotify_url %}
                    <a href="{{ album.spotify_url }}" target="_blank" class="px-4 py-2.5 bg-dark-card border border-gray-700 rounded-full hover:bg-dark-hover transition-colors">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                        </svg>
                    </a>
                    {% endif %}

                    {% if album.is_owned and tracks %}
                    <button
                        type="button"
                        data-album-id="{{ album.id }}"
                        data-fallback-artist="{{ (artist.name if artist else album.name)|e }}"
                        data-fallback-album="{{ album.name|e }}"
                        onclick="openAlbumMetadataFixPromptFromButton(this)"
                        class="px-4 py-2.5 bg-dark-card border border-gray-700 rounded-full hover:bg-dark-hover transition-colors flex items-center"
                    >
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5M18.586 2.586a2 2 0 112.828 2.828L12 14l-4 1 1-4 9.586-9.414z"/>
                        </svg>
                        Check/Fix Metadata
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Incomplete Album Warning -->
    {% if album.is_incomplete %}
    <div class="bg-yellow-900/20 border border-yellow-700/50 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <svg class="w-6 h-6 text-yellow-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="flex-1">
                <h3 class="text-yellow-400 font-semibold mb-1">Incomplete Album</h3>
                <p class="text-sm text-gray-300 mb-2">
                    This album download is incomplete. {{ album.missing_tracks|length }} track(s) failed to download.
                </p>
                {% if album.missing_tracks and album.missing_tracks|length > 0 %}
                <details class="text-sm text-gray-400">
                    <summary class="cursor-pointer hover:text-gray-300">Show missing tracks</summary>
                    <ul class="mt-2 ml-4 list-disc space-y-1">
                        {% for track_name in album.missing_tracks %}
                        <li>{{ track_name }}</li>
                        {% endfor %}
                    </ul>
                </details>
                {% endif %}
                <div class="mt-3 flex gap-2">
                    <button 
                        hx-post="/api/downloads"
                        hx-vals='{"url": "{{ album.spotify_url }}"}'
                        hx-swap="none"
                        data-success-message="Retry queued"
                        class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-md hover:bg-yellow-500 transition-colors"
                    >
                        Retry Download
                    </button>
                    <button 
                        hx-post="/api/albums/{{ album.id }}/check-completeness"
                        hx-swap="none"
                        data-success-message="Completeness checked"
                        class="px-4 py-2 bg-dark-surface text-gray-300 text-sm rounded-md hover:bg-dark-hover transition-colors border border-gray-700"
                    >
                        Recheck Completeness
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% elif album.is_owned %}
    <!-- Completeness Check for Owned Albums -->
    <div class="bg-dark-card border border-gray-800 rounded-lg p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-spotify-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="text-sm font-medium text-gray-300">Album in your library</p>
                    <p class="text-xs text-gray-500">Verify all tracks are present</p>
                </div>
            </div>
            <button 
                hx-post="/api/albums/{{ album.id }}/check-completeness"
                hx-swap="none"
                data-success-message="Completeness checked"
                class="px-4 py-2 bg-dark-surface text-gray-300 text-sm rounded-md hover:bg-dark-hover transition-colors border border-gray-700 flex items-center gap-2"
            >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                </svg>
                Check Completeness
            </button>
        </div>
    </div>
    {% endif %}
    
    <!-- Tracklist -->
    <div class="bg-dark-card rounded-xl border border-gray-800 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-800">
            <h2 class="text-lg font-semibold">Tracks</h2>
        </div>
        
        {% if tracks %}
        <div class="divide-y divide-gray-800">
            {% for track in tracks %}
            <div class="px-5 py-3 flex items-center hover:bg-dark-hover transition-colors group">
                <!-- Track Number -->
                <div class="w-10 text-center text-sm text-gray-500 group-hover:text-white">
                    {{ track.track_number or loop.index }}
                </div>
                
                <!-- Track Info -->
                <div class="flex-1 min-w-0 ml-4">
                    <p class="text-sm font-medium truncate group-hover:text-white transition-colors">
                        {{ track.name }}
                        {% if track.explicit %}
                        <span class="ml-1 px-1 py-0.5 text-[10px] bg-gray-700 text-gray-400 rounded">E</span>
                        {% endif %}
                    </p>
                    {% if track.local_path %}
                    <p class="text-xs text-spotify-green truncate">In library</p>
                    {% endif %}
                </div>
                
                <!-- Duration -->
                <div class="text-sm text-gray-400 ml-4">
                    {{ track._format_duration() if track._format_duration else '' }}
                </div>
                
                <!-- File info -->
                {% if track.file_format %}
                <div class="ml-4 px-2 py-0.5 text-xs bg-dark-surface rounded text-gray-400">
                    {{ track.file_format.upper() }}
                </div>
                {% endif %}

                {% if track.local_path %}
                <button
                    type="button"
                    data-track-id="{{ track.id }}"
                    onclick="openTrackMetadataFixPromptFromButton(this)"
                    class="ml-3 px-2.5 py-1.5 text-xs bg-dark-surface border border-gray-700 rounded hover:bg-dark-hover transition-colors"
                >
                    Fix tags
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="p-8 text-center text-gray-400">
            <p>No track information available</p>
            <button 
                hx-post="/api/albums/{{ album.id }}/refresh"
                hx-swap="none"
                class="mt-4 px-4 py-2 text-sm bg-dark-surface rounded-lg hover:bg-dark-hover transition-colors"
            >
                Refresh from Spotify
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- Download Status -->
    {% if download %}
    <div class="bg-dark-card rounded-xl border border-gray-800 p-5">
        <h3 class="font-semibold mb-4">Download Status</h3>
        <div class="flex items-center space-x-4">
            <div class="flex-1">
                <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div 
                        class="h-full transition-all duration-300 {% if download.status.value == 'completed' %}bg-spotify-green{% elif download.status.value == 'failed' %}bg-red-500{% else %}bg-blue-500{% endif %}"
                        style="width: {{ download.progress }}%"
                    ></div>
                </div>
                <div class="flex justify-between mt-2 text-sm text-gray-400">
                    <span>{{ download.status.value|title }}</span>
                    <span>{{ download.progress }}%</span>
                </div>
            </div>
            
            {% if download.status.value in ['pending', 'queued', 'downloading'] %}
            <button 
                hx-delete="/api/downloads/{{ download.id }}"
                hx-swap="none"
                class="px-4 py-2 text-sm bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition-colors"
            >
                Cancel
            </button>
            {% elif download.status.value == 'failed' %}
            <button 
                hx-post="/api/downloads/{{ download.id }}/retry"
                hx-swap="none"
                class="px-4 py-2 text-sm bg-blue-600/20 text-blue-400 rounded-lg hover:bg-blue-600/30 transition-colors"
            >
                Retry
            </button>
            {% endif %}
        </div>
        
        {% if download.error_message %}
        <p class="mt-3 text-sm text-red-400">{{ download.error_message }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="metadata-modal" class="fixed inset-0 z-50 hidden">
    <div id="metadata-modal-overlay" class="absolute inset-0 bg-black/70"></div>
    <div class="relative z-10 h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-dark-card border border-gray-700 rounded-xl shadow-2xl overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-800 flex items-start justify-between gap-3">
                <div>
                    <h3 id="metadata-modal-title" class="text-lg font-semibold text-white"></h3>
                    <p id="metadata-modal-subtitle" class="text-sm text-gray-400 mt-1"></p>
                </div>
                <button id="metadata-modal-close" type="button" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="metadata-modal-form" class="px-5 py-4 space-y-4 max-h-[65vh] overflow-y-auto"></form>
            <div class="px-5 py-4 border-t border-gray-800 flex items-center justify-end gap-3">
                <button id="metadata-modal-cancel" type="button" class="px-4 py-2 bg-dark-surface border border-gray-700 rounded-lg hover:bg-dark-hover transition-colors">
                    Cancel
                </button>
                <button id="metadata-modal-confirm" type="button" class="px-4 py-2 bg-spotify-green text-black font-medium rounded-lg hover:bg-green-400 transition-colors">
                    Apply
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const metadataModal = {
        root: document.getElementById('metadata-modal'),
        overlay: document.getElementById('metadata-modal-overlay'),
        title: document.getElementById('metadata-modal-title'),
        subtitle: document.getElementById('metadata-modal-subtitle'),
        form: document.getElementById('metadata-modal-form'),
        confirm: document.getElementById('metadata-modal-confirm'),
        cancel: document.getElementById('metadata-modal-cancel'),
        close: document.getElementById('metadata-modal-close'),
    };

    let activeModalResolver = null;
    let activeEscapeHandler = null;

    function notify(message, type = 'info') {
        window.dispatchEvent(new CustomEvent('notify', { detail: { message, type } }));
    }

    function escapeHtml(value) {
        return String(value ?? '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    function closeMetadataModal(result = null) {
        if (!metadataModal.root || metadataModal.root.classList.contains('hidden')) {
            return;
        }

        if (activeEscapeHandler) {
            document.removeEventListener('keydown', activeEscapeHandler);
            activeEscapeHandler = null;
        }

        metadataModal.root.classList.add('hidden');
        metadataModal.form.innerHTML = '';

        if (activeModalResolver) {
            activeModalResolver(result);
            activeModalResolver = null;
        }
    }

    function openMetadataModal(config) {
        return new Promise((resolve) => {
            activeModalResolver = resolve;

            metadataModal.title.textContent = config.title || 'Edit metadata';
            metadataModal.subtitle.textContent = config.subtitle || '';
            metadataModal.confirm.textContent = config.confirmLabel || 'Apply';

            metadataModal.form.innerHTML = (config.fields || []).map((field) => {
                const inputType = field.type === 'number' ? 'number' : 'text';
                const value = escapeHtml(field.value ?? '');
                const min = field.type === 'number' ? 'min="1"' : '';
                const required = field.required ? 'required' : '';
                const placeholder = field.placeholder ? `placeholder="${escapeHtml(field.placeholder)}"` : '';

                return `
                    <div>
                        <label class="block text-sm font-medium text-gray-200 mb-1" for="metadata-field-${field.key}">${escapeHtml(field.label)}</label>
                        <input
                            id="metadata-field-${field.key}"
                            name="${escapeHtml(field.key)}"
                            type="${inputType}"
                            value="${value}"
                            ${min}
                            ${required}
                            ${placeholder}
                            class="w-full px-3 py-2 bg-dark-surface border border-gray-700 rounded-lg text-sm text-gray-100 focus:outline-none focus:border-spotify-green"
                        />
                        ${field.help ? `<p class="text-xs text-gray-500 mt-1">${escapeHtml(field.help)}</p>` : ''}
                    </div>
                `;
            }).join('');

            metadataModal.root.classList.remove('hidden');

            const firstInput = metadataModal.form.querySelector('input');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }

            const handleConfirm = () => {
                const data = {};
                for (const field of (config.fields || [])) {
                    const element = metadataModal.form.querySelector(`[name="${field.key}"]`);
                    if (!element) {
                        continue;
                    }

                    const rawValue = element.value.trim();
                    if (field.required && !rawValue) {
                        element.focus();
                        notify(`${field.label} is required`, 'warning');
                        return;
                    }

                    data[field.key] = rawValue;
                }

                closeMetadataModal(data);
            };

            metadataModal.confirm.onclick = handleConfirm;
            metadataModal.cancel.onclick = () => closeMetadataModal(null);
            metadataModal.close.onclick = () => closeMetadataModal(null);
            metadataModal.overlay.onclick = () => closeMetadataModal(null);

            activeEscapeHandler = (event) => {
                if (event.key === 'Escape') {
                    closeMetadataModal(null);
                }
            };

            document.addEventListener('keydown', activeEscapeHandler);
        });
    }

    async function openAlbumMetadataFixPrompt(albumId, fallbackArtistName, fallbackAlbumName) {
        try {
            const previewResponse = await fetch(`/api/albums/${albumId}/metadata-preview`);
            if (!previewResponse.ok) {
                const err = await previewResponse.json().catch(() => ({}));
                notify(err.detail || 'Could not load album metadata preview', 'error');
                return;
            }

            const preview = await previewResponse.json();
            if (!preview.track_count) {
                notify('No local tracks found for this album', 'warning');
                return;
            }

            const existingAlbumArtists = (preview.unique_album_artists || []).filter(Boolean);
            const defaultAlbumArtist = preview.suggested_album_artist || fallbackArtistName || '';
            const defaultAlbumName = preview.album_name || fallbackAlbumName || '';

            const modalData = await openMetadataModal({
                title: 'Fix Album Metadata',
                subtitle: `Apply the same album-level values to ${preview.track_count} track(s). Current album artist values: ${existingAlbumArtists.length ? existingAlbumArtists.join(', ') : 'none'}`,
                confirmLabel: 'Rewrite Tags',
                fields: [
                    {
                        key: 'album_artist',
                        label: 'Album Artist / BAND',
                        value: defaultAlbumArtist,
                        required: true,
                        help: 'Use one consistent value for the whole album.'
                    },
                    {
                        key: 'album_name',
                        label: 'Album Name',
                        value: defaultAlbumName,
                        required: false,
                    },
                ]
            });

            if (!modalData) {
                return;
            }

            const albumArtist = (modalData.album_artist || '').trim();
            const albumName = (modalData.album_name || '').trim();

            const fixResponse = await fetch(`/api/albums/${albumId}/metadata/fix`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    album_artist: albumArtist,
                    album_name: albumName || defaultAlbumName,
                }),
            });

            const result = await fixResponse.json().catch(() => ({}));

            if (!fixResponse.ok) {
                notify(result.detail || 'Failed to update album metadata', 'error');
                return;
            }

            const failedCount = (result.failed_tracks || []).length;
            if (failedCount > 0) {
                notify(`Metadata updated for ${result.updated_tracks} tracks (${failedCount} failed)`, 'warning');
            } else {
                notify(`Metadata updated for ${result.updated_tracks} tracks`, 'success');
            }
        } catch (error) {
            notify('Unexpected error while fixing album metadata', 'error');
        }
    }

    function openAlbumMetadataFixPromptFromButton(button) {
        const albumId = parseInt(button.dataset.albumId, 10);
        const fallbackArtistName = button.dataset.fallbackArtist || '';
        const fallbackAlbumName = button.dataset.fallbackAlbum || '';
        openAlbumMetadataFixPrompt(albumId, fallbackArtistName, fallbackAlbumName);
    }

    async function openTrackMetadataFixPrompt(trackId) {
        try {
            const previewResponse = await fetch(`/api/tracks/${trackId}/metadata-preview`);
            if (!previewResponse.ok) {
                const err = await previewResponse.json().catch(() => ({}));
                notify(err.detail || 'Could not load track metadata preview', 'error');
                return;
            }

            const preview = await previewResponse.json();
            const metadata = preview.metadata || {};

            const modalData = await openMetadataModal({
                title: 'Fix Track Metadata',
                subtitle: `Track: ${preview.track_name}`,
                confirmLabel: 'Rewrite Tags',
                fields: [
                    { key: 'title', label: 'Title', value: metadata.title || preview.track_name || '' },
                    { key: 'artist', label: 'Artist', value: metadata.artist || '', help: 'Keep featured artists here if needed.' },
                    { key: 'album', label: 'Album', value: metadata.album || '' },
                    { key: 'albumartist', label: 'Album Artist', value: metadata.albumartist || '' },
                    { key: 'track_number', label: 'Track Number', value: metadata.track_number || '', type: 'number' },
                    { key: 'disc_number', label: 'Disc Number', value: metadata.disc_number || 1, type: 'number' },
                ]
            });

            if (!modalData) {
                return;
            }

            const title = (modalData.title || '').trim();
            const artist = (modalData.artist || '').trim();
            const album = (modalData.album || '').trim();
            const albumartist = (modalData.albumartist || '').trim();
            const trackNumber = parseInt(modalData.track_number, 10);
            const discNumber = parseInt(modalData.disc_number, 10);

            const payload = {
                title: title || null,
                artist: artist || null,
                album: album || null,
                albumartist: albumartist || null,
                track_number: Number.isInteger(trackNumber) && trackNumber > 0 ? trackNumber : null,
                disc_number: Number.isInteger(discNumber) && discNumber > 0 ? discNumber : null,
            };

            const fixResponse = await fetch(`/api/tracks/${trackId}/metadata/fix`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            const result = await fixResponse.json().catch(() => ({}));

            if (!fixResponse.ok) {
                notify(result.detail || 'Failed to update track metadata', 'error');
                return;
            }

            notify('Track metadata updated', 'success');
            setTimeout(() => window.location.reload(), 400);
        } catch (error) {
            notify('Unexpected error while fixing track metadata', 'error');
        }
    }

    function openTrackMetadataFixPromptFromButton(button) {
        const trackId = parseInt(button.dataset.trackId, 10);
        openTrackMetadataFixPrompt(trackId);
    }
</script>
{% endblock %}
